import{w as e,a as t,c as o,o as n,q as l,D as a,b as r,e as s,j as i,g as c,k as u,u as d,B as v,v as f,f as h,t as p,T as g,F as b,y as x,n as y,h as w,l as m,E as k,x as C,G as z,A}from"./vendor-vue-BkEISqGT.js";import{N as _,O as j,o as S,A as O,M as I,e as M,i as B,q as T,p as F,D,t as R,H as E,a as P}from"./vendor-fabric-CV99j_cf.js";import{u as L}from"./drawing-store-DaNXGEXc.js";import{u as N,b as W,a as U}from"./main-Bc4UwIiF.js";import"./apiHelpers-DHex_rN5.js";import"./vendor-utils-BdUT8LFy.js";let V=0;const $=()=>`s${++V}_${Date.now()}`,X=[{key:"process",icon:"â–­",label:"Process"},{key:"rounded",icon:"â–¢",label:"Rounded Rect"},{key:"decision",icon:"â—‡",label:"Decision"},{key:"terminal",icon:"â¬­",label:"Terminal"},{key:"circle",icon:"â—‹",label:"Circle"},{key:"ellipse",icon:"â¬¯",label:"Ellipse"},{key:"triangle",icon:"â–³",label:"Triangle"}],q=["sans-serif","serif","monospace","Georgia","Arial","Verdana","Courier New","Times New Roman","Trebuchet MS","Impact"],Y=e=>20*Math.round(e/20);function H(e,t){const o=e.getCenterPoint();t.set({left:o.x,top:o.y,angle:e.angle??0}),t.setCoords()}function Z(e){const{left:t,top:o,width:n,height:l}=e.getBoundingRect(!0);return{top:{x:t+n/2,y:o-10},right:{x:t+n+10,y:o+l/2},bottom:{x:t+n/2,y:o+l+10},left:{x:t-10,y:o+l/2}}}function G(e,t,o){return Object.entries(Z(e)).map(([e,n])=>({k:e,d:Math.hypot(n.x-t,n.y-o),x:n.x,y:n.y})).sort((e,t)=>e.d-t.d)[0]}function J(){let n=null,l=null;const a=new Map,r=new Map;let s=null,i=null,c={x:0,y:0},u=!1,d={x:0,y:0},v=[],f=-1,h=0;const p=t("pen"),g=t("#3b82f6"),b=t(3),x=t(!1),y=t("#ffffff"),w=t("process"),m=t(!0),k=t(!1),C=t(null),z=t({top:0,left:0,visible:!1}),A=t(!1),L=t("sans-serif"),N=t(14),W=t(!1),U=t(!1),V=t(!1),J=t("center"),K=t("#1f2937");function Q(e){if(p.value=e,!n)return;const t="select"===e,o="connector"===e,l="text"===e;n.isDrawingMode="pen"===e||"eraser"===e,n.selection=t,n.defaultCursor=o?"crosshair":l?"text":t?"default":"crosshair",n.hoverCursor=o?"crosshair":l?"text":t?"move":"crosshair",n.getObjects().forEach(e=>{e._labelFor?e.set({selectable:!1,evented:!1,hasControls:!1,hasBorders:!1}):(e._isConnector,e.set({selectable:t,evented:!0,hasControls:t,hasBorders:t})),e.setCoords()}),t||n.discardActiveObject(),ee(),n.renderAll()}function ee(){if(!n||"pen"!==p.value&&"eraser"!==p.value)return;const e=new _(n);"eraser"===p.value?(e.color=y.value||"#ffffff",e.width=3*b.value,n.off("path:created"),n.on("path:created",({path:e})=>{"eraser"===p.value&&(e.set({selectable:!1,evented:!1,hasControls:!1,hasBorders:!1,stroke:y.value||"#ffffff"}),n.bringObjectToFront(e),n.renderAll(),se())})):(n.off("path:created"),e.color=g.value,e.width=b.value,n.on("path:created",({path:e})=>{"pen"===p.value&&(e.set({selectable:!1,evented:!1,hasControls:!1,hasBorders:!1}),se())})),n.freeDrawingBrush=e}function te(e,t){const o=new P(e,t);return n.getObjects().filter(e=>e._shapeId&&!e._isConnector&&!e._labelFor).reverse().find(e=>(e.setCoords(),e.containsPoint(o)))??null}function oe(e){const t=n.getObjects().find(t=>t._shapeId===e.fromId&&!t._labelFor),o=n.getObjects().find(t=>t._shapeId===e.toId&&!t._labelFor);if(!t||!o)return;const l=Z(t)[e.fromAnchor],a=Z(o)[e.toAnchor];if(!l||!a)return;e.pathObj&&n.remove(e.pathObj);const r=function(e,t,o,n,l){const a=Math.atan2(n-t,o-e),r=.42,s=e=>e.toFixed(1),i=`M ${s(e)} ${s(t)} L ${s(o)} ${s(n)} L ${s(o-14*Math.cos(a-r))} ${s(n-14*Math.sin(a-r))} M ${s(o)} ${s(n)} L ${s(o-14*Math.cos(a+r))} ${s(n-14*Math.sin(a+r))}`,c=new E(i,{stroke:l,strokeWidth:2,fill:"",selectable:!0,evented:!0,hasControls:!0,hasBorders:!0,lockScalingX:!0,lockScalingY:!0,lockRotation:!0});return c._isConnector=!0,c}(l.x,l.y,a.x,a.y,e.color);e.pathObj=r,n.add(r),n.sendObjectToBack(r)}function ne(e){e?._shapeId&&(a.forEach(t=>{t.fromId!==e._shapeId&&t.toId!==e._shapeId||oe(t)}),n.renderAll())}function le(e){const t=e.e;if(t.ctrlKey||t.metaKey)return u=!0,d={x:t.clientX,y:t.clientY},k.value=!0,n.getObjects().forEach(e=>e.set({evented:!1})),n.discardActiveObject(),void n.renderAll();if("text"===p.value){const e=n.getScenePoint(t);return void function(e,t){const o=new D("Text",{left:Y(e),top:Y(t),originX:"left",originY:"top",width:200,fontSize:18,fontFamily:"sans-serif",fill:g.value,textAlign:"left",editable:!0});n.add(o),n.setActiveObject(o),o.enterEditing(),n.renderAll(),Q("select"),se()}(e.x,e.y)}if("connector"!==p.value)return;const o=n.getScenePoint(t),l=te(o.x,o.y);if(!l)return;t.stopPropagation();const a=G(l,o.x,o.y),r=new R([a.x,a.y,a.x,a.y],{stroke:g.value,strokeWidth:2,strokeDashArray:[6,4],selectable:!1,evented:!1});n.add(r),s={fromId:l._shapeId,fromAnchor:a.k,tempLine:r}}function ae(e){const t=e.e;if(u){const e=t.clientX-d.x,o=t.clientY-d.y;d={x:t.clientX,y:t.clientY};const l=n.viewportTransform.slice();return l[4]+=e,l[5]+=o,n.setViewportTransform(l),void n.requestRenderAll()}if("connector"!==p.value)return;const o=n.getScenePoint(t);c={x:o.x,y:o.y},s?.tempLine&&s.tempLine.set({x2:o.x,y2:o.y}),i=te(o.x,o.y),n.requestRenderAll()}function re(e){if(u)return u=!1,k.value=!1,void Q(p.value);if("connector"!==p.value||!s)return;const{tempLine:t,fromId:o,fromAnchor:l}=s;t&&n.remove(t),s=null,i=null;const r=n.getScenePoint(e.e),c=te(r.x,r.y);if(c&&c._shapeId!==o){const e=G(c,r.x,r.y),t=$(),n={id:t,fromId:o,toId:c._shapeId,fromAnchor:l,toAnchor:e.k,color:g.value,pathObj:null};a.set(t,n),oe(n),se()}n.renderAll(),Q("select")}function se(){if(h>0||!n)return;h++;const e=pe();if(h--,!e)return;const t=JSON.stringify(e);v[f]!==t&&(v.splice(f+1),v.push(t),f++,v.length>60&&(v.shift(),f--))}async function ie(){f>0&&n&&(f--,await ge(JSON.parse(v[f])))}async function ce(){f<v.length-1&&n&&(f++,await ge(JSON.parse(v[f])))}function ue(){if(!n)return;const e=n.getActiveObject();if(!e)return;if("activeselection"===e.type||"activeSelection"===e.type){const t=e.getObjects().filter(e=>!e._labelFor);if(!t.length)return;n.discardActiveObject(),t.forEach(e=>n.remove(e));const o=new j(t);o._shapeId=$(),n.add(o),n.setActiveObject(o)}else if("group"===e.type){const t=e.calcTransformMatrix(),o=[...e.getObjects()];n.remove(e),o.forEach(e=>{const o=S.qrDecompose(S.multiplyTransformMatrices(t,e.calcTransformMatrix()));e.set({...o,left:o.translateX,top:o.translateY,flipX:!1,flipY:!1,originX:"center",originY:"center",selectable:!0,evented:!0}),e.setCoords(),n.add(e)}),n.setActiveObject(new O(o,{canvas:n}))}n.requestRenderAll(),se()}function de(){if(!n)return;const e=n.getActiveObject();if(!e)return;("activeselection"===e.type||"activeSelection"===e.type?e.getObjects():[e]).forEach(e=>{if(e._isConnector){for(const[t,o]of a)if(o.pathObj===e){a.delete(t);break}n.remove(e)}else{if(e._shapeId){const t=r.get(e._shapeId);t&&(n.remove(t),r.delete(e._shapeId));for(const[o,l]of a)l.fromId!==e._shapeId&&l.toId!==e._shapeId||(l.pathObj&&n.remove(l.pathObj),a.delete(o))}n.remove(e)}}),n.discardActiveObject(),n.renderAll(),se()}e(g,ee),e(b,ee),e(x,e=>{y.value=e?"#18181b":"#ffffff"}),e(y,e=>{"eraser"===p.value&&n?.freeDrawingBrush&&(n.freeDrawingBrush.color=e)});function ve(e){if(!e||!l)return;const t=l.getBoundingClientRect(),o=e.getBoundingRect();z.value={visible:!0,left:t.left+o.left+o.width/2,top:t.top+o.top-60}}function fe(e,t){C.value&&n&&(C.value.set(e,t),n.renderAll())}function he(){if(!n)return;const e=document.createElement("canvas");e.width=n.width,e.height=n.height;const t=e.getContext("2d");t.fillStyle=y.value,t.fillRect(0,0,e.width,e.height);const o=new Image;o.onload=()=>{t.drawImage(o,0,0);const n=document.createElement("a");n.download=`canvas-${Date.now()}.png`,n.href=e.toDataURL("image/png"),n.click()},o.src=n.toDataURL({format:"png",quality:1})}function pe(){if(!n)return null;const e=n.getObjects().filter(e=>e._isConnector);e.forEach(e=>n.remove(e));const t=n.toJSON(["_shapeId","_labelFor","_isConnector"]);return e.forEach(e=>{n.add(e),n.sendObjectToBack(e)}),{canvas:t,connections:[...a.values()].map(({id:e,fromId:t,toId:o,fromAnchor:n,toAnchor:l,color:a})=>({id:e,fromId:t,toId:o,fromAnchor:n,toAnchor:l,color:a})),bg:y.value}}async function ge(e){if(!n||!e)return;h++,a.clear(),r.clear();let t=e,o=[],l=y.value;e.canvas&&(t=e.canvas,o=e.connections||[],l=e.bg||y.value),l&&(y.value=l),n.getObjects().forEach(e=>{e._isConnector||n.remove(e)});try{await n.loadFromJSON(t),n.getObjects().forEach(e=>{const t=!(!e._isConnector&&!e._labelFor);e.set({selectable:!t&&"select"===p.value,evented:!0,hasControls:!t&&"select"===p.value,hasBorders:!t&&"select"===p.value}),e.setCoords(),e._labelFor&&r.set(e._labelFor,e)}),o.forEach(e=>{const t={...e,pathObj:null};a.set(e.id,t),oe(t)}),n.renderAll()}catch(s){}finally{h--}}function be(){if(!n)return;Q("select");const e=n.getObjects().filter(e=>!e._isConnector&&!e._labelFor);e.length&&(1===e.length?n.setActiveObject(e[0]):n.setActiveObject(new O(e,{canvas:n})),n.requestRenderAll())}return{getFabricInstance:()=>n,isReady:o(()=>null!==n),tool:p,strokeColor:g,lineWidth:b,canvasDark:x,bgColor:y,activeShape:w,gridVisible:m,isPanning:k,editingText:C,toolbar:z,showFonts:A,txtFont:L,txtSize:N,txtBold:W,txtItalic:U,txtUnder:V,txtAlign:J,txtColor:K,SHAPES:X,FONTS:q,init:function(e,t){if(n)return n;if(!e||!t)return null;l=e;try{return n=new I(e,{isDrawingMode:!1,width:t.clientWidth,height:t.clientHeight,preserveObjectStacking:!0,stopContextMenu:!0,allowTouchScrolling:!1}),n.on("text:editing:entered",({target:e})=>{var t;C.value=e,(t=e)&&(L.value=t.fontFamily??"sans-serif",N.value=t.fontSize??14,W.value="bold"===t.fontWeight,U.value="italic"===t.fontStyle,V.value=!0===t.underline,J.value=t.textAlign??"center",K.value=t.fill??"#1f2937"),ve(e)}),n.on("text:editing:exited",()=>{const e=C.value;C.value=null,z.value.visible=!1,A.value=!1,e?._labelFor&&(e.set({selectable:!1,evented:!1}),e.setCoords(),n.discardActiveObject()),n.renderAll(),se()}),n.on("mouse:dblclick",({target:e})=>{if(!e?._shapeId||e._labelFor||"select"!==p.value)return;const t=r.get(e._shapeId);t&&(t.set({selectable:!0,evented:!0}),t.setCoords(),n.setActiveObject(t),t.enterEditing(),n.requestRenderAll())}),n.on("object:moving",({target:e})=>{if(!e._isConnector){if(e._labelFor||(e.set({left:Y(e.left),top:Y(e.top)}),e.setCoords()),e._shapeId){const t=r.get(e._shapeId);t&&H(e,t),ne(e)}C.value&&ve(C.value)}}),n.on("object:modified",({target:e})=>{if(e._isConnector||e._labelFor||(e.set({left:Y(e.left),top:Y(e.top)}),e.setCoords()),e._shapeId){const t=r.get(e._shapeId);t&&H(e,t),ne(e)}se()}),n.on("after:render",()=>{C.value&&ve(C.value),function(){if("connector"!==p.value||!i)return;const e=n.getContext(),t=n.viewportTransform,o=G(i,c.x,c.y);e.save(),Object.entries(Z(i)).forEach(([n,l])=>{const{x:a,y:r}=((e,t,o)=>({x:e[0]*t+e[2]*o+e[4],y:e[1]*t+e[3]*o+e[5]}))(t,l.x,l.y),s=n===o.k;e.beginPath(),e.arc(a,r,s?8:5,0,2*Math.PI),e.fillStyle=s?"#ef4444":"#3b82f6",e.strokeStyle="#ffffff",e.lineWidth=2,e.fill(),e.stroke()}),e.restore()}()}),n.on("mouse:down",le),n.on("mouse:move",ae),n.on("mouse:up",re),Q("pen"),n}catch(o){return null}},dispose:function(){n?.dispose(),n=null},resize:function(e,t){n?.setDimensions({width:e,height:t}),n?.renderAll()},setTool:Q,drawGrid:function(e){if(!e||!n)return;const t=window.devicePixelRatio||1,o=Math.round(e.offsetWidth*t),l=Math.round(e.offsetHeight*t);e.width===o&&e.height===l||(e.width=o,e.height=l);const a=e.getContext("2d");if(a.clearRect(0,0,o,l),!m.value)return;const r=n.viewportTransform,s=20*n.getZoom()*t,i=(r[4]*t%s+s)%s,c=(r[5]*t%s+s)%s;a.fillStyle=x.value?"rgba(255,255,255,0.18)":"rgba(0,0,0,0.15)";for(let n=i;n<o;n+=s)for(let e=c;e<l;e+=s)a.beginPath(),a.arc(n,e,t,0,2*Math.PI),a.fill()},_fc_onAfterRender:function(e){return n?(n.on("after:render",e),()=>n.off("after:render",e)):()=>{}},addShape:function(e){if(!n)return;w.value=e,Q("select");const t=Y(n.width/2),o=Y(n.height/2),l=$(),a=function(e,t){const o={originX:"center",originY:"center",fill:t+"18",stroke:t,strokeWidth:2},n={process:()=>new F({...o,width:160,height:72,rx:4,ry:4}),rounded:()=>new F({...o,width:160,height:72,rx:24,ry:24}),decision:()=>new F({...o,width:100,height:100,rx:4,ry:4,angle:45,scaleX:.9,scaleY:.6}),terminal:()=>new F({...o,width:160,height:56,rx:28,ry:28}),circle:()=>new T({...o,radius:52}),ellipse:()=>new B({...o,rx:82,ry:48}),triangle:()=>new M({...o,width:130,height:110})};return(n[e]??n.process)()}(e,g.value);a._shapeId=l,a.set({left:t,top:o}),a.setCoords();const s=function(e,t,o){const n=new D("",{left:t,top:o,originX:"center",originY:"center",width:130,fontSize:13,fontFamily:"sans-serif",fill:"#1f2937",textAlign:"center",editable:!0,selectable:!1,evented:!1,hasControls:!1,hasBorders:!1,lockMovementX:!0,lockMovementY:!0});return n._labelFor=e,n}(l,t,o);n.add(a),n.add(s),r.set(l,s),n.setActiveObject(a),n.renderAll(),se()},addText:function(){n&&Q("text")},selectAll:be,undo:ie,redo:ce,snap:se,clear:function(){n&&(a.clear(),r.clear(),n.clear(),n.renderAll(),se())},deleteSelected:de,groupOrUngroup:ue,exportPNG:he,zoomIn:()=>n&&(n.setZoom(Math.min(5,1.2*n.getZoom())),n.requestRenderAll()),zoomOut:()=>n&&(n.setZoom(Math.max(.1,n.getZoom()/1.2)),n.requestRenderAll()),zoomReset:()=>n&&(n.setZoom(1),n.setViewportTransform([1,0,0,1,0,0]),n.requestRenderAll()),toggleBold:()=>{W.value=!W.value,fe("fontWeight",W.value?"bold":"normal")},toggleItalic:()=>{U.value=!U.value,fe("fontStyle",U.value?"italic":"normal")},toggleUnder:()=>{V.value=!V.value,fe("underline",V.value)},setAlign:e=>{J.value=e,fe("textAlign",e)},setFont:e=>{L.value=e,A.value=!1,fe("fontFamily",e)},changeSize:e=>{N.value=Math.max(6,N.value+e),fe("fontSize",N.value)},applyTxtColor:e=>{K.value=e.target.value,fe("fill",K.value)},getData:function(){return pe()},setData:async function(e){const t="string"==typeof e?JSON.parse(e):e;await ge(t),v.length=0,f=-1,se()},setupKeyboard:function(e={}){const t=t=>{const o=t.target.tagName;if("INPUT"===o||"TEXTAREA"===o||t.target.isContentEditable)return;const n=t.ctrlKey||t.metaKey,l=t.shiftKey,a=t.key;if(n)return"z"!==a||l?"z"===a&&l||"y"===a?(t.preventDefault(),void ce()):"s"===a?(t.preventDefault(),void e.onSave?.()):"p"===a?(t.preventDefault(),void he()):"a"===a?(t.preventDefault(),void be()):"g"===a?(t.preventDefault(),void ue()):void 0:(t.preventDefault(),void ie());switch(a){case"v":Q("select");break;case"d":Q("pen");break;case"e":Q("eraser");break;case"t":Q("text");break;case"c":e.onOpenColor?.();break;case"s":e.onOpenSize?.();break;case"Delete":case"Backspace":de()}};return document.addEventListener("keydown",t),()=>document.removeEventListener("keydown",t)}}}const K={class:"flex w-full h-full min-h-0 overflow-hidden rounded-xl border border-zinc-200 bg-zinc-50"},Q={class:"relative"},ee={class:"text-[9px] text-zinc-400 shrink-0"},te={key:0,class:"absolute bottom-full mb-2 left-0 z-10 bg-white border border-zinc-200 rounded-xl shadow-xl py-1 min-w-[155px] max-h-52 overflow-y-auto"},oe=["onClick"],ne={class:"flex items-center gap-0.5"},le={class:"text-xs font-mono w-7 text-center tabular-nums text-zinc-700 select-none"},ae=["title","onClick"],re={width:"14",height:"12",viewBox:"0 0 14 12",fill:"none"},se=["x","y","width","height"],ie={class:"relative flex items-center justify-center w-7 h-7 rounded-lg hover:bg-zinc-100 transition-colors cursor-pointer",title:"Text color"},ce=["value"],ue={class:"flex flex-col items-center w-14 shrink-0 h-full py-3 gap-0.5 border-r border-zinc-200 bg-white rounded-l-xl overflow-y-auto overflow-x-visible"},de={class:"text-base"},ve={class:"relative shrink-0 my-0.5",title:"Stroke / fill colour  [C]"},fe={class:"grid grid-cols-6 gap-1.5"},he=["onClick"],pe={class:"w-6 h-6 flex items-center justify-center"},ge={class:"text-[10px] font-mono tabular-nums text-zinc-400 select-none"},be={class:"relative flex flex-col items-center shrink-0"},xe=["title"],ye={class:"text-base leading-none"},we=["onClick"],me={class:"text-base w-5 text-center leading-none"},ke={class:"text-xs whitespace-nowrap"},Ce=["title","disabled"],ze={key:0,class:"w-4 h-4",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},Ae={key:1,class:"w-4 h-4 animate-spin",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},_e={key:0,class:"absolute inset-0 z-30 flex items-center justify-center bg-white/60 backdrop-blur-sm"},je={key:1,class:"absolute bottom-3 left-3 z-10 pointer-events-none text-[10px] font-medium text-zinc-400 bg-white/80 backdrop-blur-sm px-2 py-1 rounded-full border border-zinc-200 select-none"},Se={class:"absolute bottom-3 left-1/2 -translate-x-1/2 z-10 pointer-events-none text-[10px] text-zinc-400 bg-white/80 backdrop-blur-sm px-3 py-1 rounded-full border border-zinc-200 select-none whitespace-nowrap"},Oe={class:"absolute bottom-12 right-4 z-10 flex flex-col gap-1"},Ie={__name:"DrawerCanvas",props:{type:{type:String,default:"task"},entityId:{type:[Number,String],default:null}},setup(_){const j=_,S=L(),O=N(),I=W(),M=U(),B=J(),T=t(null),F=t(null),D=t(null),R=t(!1),E=t(!1),P=t(!1),V=t(null),$=t(null),Y=t(null),H=t({top:0,left:0}),Z=t({top:0,left:0}),G=t({top:0,left:0}),Ie=o(()=>j.entityId?j.entityId:"project"===j.type?I.selectedProjectId:O.selectedTaskId),Me=o(()=>j.type),Be=o(()=>{const e="project"===Me.value?"projects":"tasks";return M.layouts?.[e]?.detailsSections?.canvas?.visible??!1}),Te=o(()=>X.find(e=>e.key===B.activeShape.value)??X[0]),Fe=o(()=>Math.min(20,Math.max(4,.5*B.lineWidth.value))+"px"),De=t(!1),Re=o(()=>De.value&&!!B.getFabricInstance?.()),Ee=o(()=>({pen:"Pen  [D]",eraser:"Eraser  [E]",select:"Select  [V]",connector:"Connector",text:"Text  [T]"}[B.tool.value]??"")),Pe=o(()=>B.isPanning.value?"grabbing":"default");function Le(){D.value&&B.drawGrid(D.value)}let Ne,We,Ue;async function Ve(){Ie.value&&Be.value&&Re.value&&await async function(){const e=Ie.value;if(!e)return;try{const t=await S.loadDrawing(j.type,e);if(!t)return void B.clear();let o=t;"string"==typeof t?o=JSON.parse(t):t?.data&&(o="string"==typeof t.data?JSON.parse(t.data):t.data);const n=o.canvas||o;B.clear(),await B.setData(n)}catch(t){}}()}async function $e(){const e=Ie.value,t=B.getData();e&&t&&await S.saveDrawing({type:j.type,id:e,data:t})}function Xe(){R.value=!1,E.value=!1,P.value=!1}function qe(e,t){t?.stopPropagation();const o={shape:V,brush:$,color:Y},n={shape:H,brush:Z,color:G},l={shape:R,brush:E,color:P},a=o[e]?.value;if(a){const t=a.getBoundingClientRect();n[e].value={top:t.top,left:t.right+10}}const r=l[e].value;Xe(),r||(l[e].value=!0)}n(async()=>{if(!T.value||!F.value)return;B.init(T.value,F.value)&&(await l(),De.value=!0,We=B.setupKeyboard({onSave:$e,onOpenColor:()=>qe("color"),onOpenSize:()=>qe("brush")}),Ue=B._fc_onAfterRender(Le),D.value&&F.value&&(D.value.width=F.value.clientWidth,D.value.height=F.value.clientHeight),Le(),Ne=new ResizeObserver(([e])=>{const{width:t,height:o}=e.contentRect;B.resize(t,o),D.value&&(D.value.width=t,D.value.height=o,Le())}),Ne.observe(F.value),document.addEventListener("click",Xe),B.value?._fc?.renderAll())}),a(()=>{Ne?.disconnect(),Ue?.(),B.dispose(),We?.(),document.removeEventListener("click",Xe)}),e(Ie,Ve),e(Be,Ve),e(Re,e=>{e&&Ve()});const Ye=e=>qe("shape",e),He=e=>qe("brush",e),Ze=e=>qe("color",e);const Ge=(e=!1,t=!1)=>["flex items-center justify-center w-9 h-9 rounded-xl transition-all duration-100 cursor-pointer","hover:scale-105 active:scale-95 select-none",e?"bg-blue-500/15 text-blue-600 ring-1 ring-blue-500/30":"text-zinc-400 hover:bg-zinc-100 hover:text-zinc-700",t&&!e?"hover:!bg-red-50 hover:!text-red-500":""].join(" "),Je=(e=!1)=>["flex items-center justify-center h-7 min-w-[28px] px-1.5 rounded-lg text-xs font-medium","transition-all duration-75 cursor-pointer select-none",e?"bg-zinc-800 text-white":"text-zinc-600 hover:bg-zinc-100"].join(" ");return e([()=>B.gridVisible.value,()=>B.canvasDark.value],Le),(e,t)=>(r(),s("div",K,[(r(),i(m,{to:"body"},[c(g,{"enter-active-class":"transition duration-150 ease-out","enter-from-class":"opacity-0 translate-y-1 scale-95","leave-active-class":"transition duration-100 ease-in","leave-to-class":"opacity-0 translate-y-1 scale-95"},{default:u(()=>[d(B).toolbar.value.visible&&d(B).editingText.value?(r(),s("div",{key:0,class:"fixed z-[9999] flex items-center gap-1 px-2 py-1.5 bg-white border border-zinc-200 rounded-2xl shadow-xl shadow-black/10 -translate-x-1/2 pointer-events-auto",style:f({top:d(B).toolbar.value.top+"px",left:d(B).toolbar.value.left+"px"}),onMousedown:t[7]||(t[7]=v(()=>{},["prevent"]))},[h("div",Q,[h("button",{class:"flex items-center gap-1 h-7 px-2 rounded-lg text-xs text-zinc-700 hover:bg-zinc-100 transition-colors min-w-[96px] justify-between",onClick:t[0]||(t[0]=v(e=>d(B).showFonts.value=!d(B).showFonts.value,["stop"]))},[h("span",{class:"truncate max-w-[72px]",style:f({fontFamily:d(B).txtFont.value})},p(d(B).txtFont.value),5),h("span",ee,p(d(B).showFonts.value?"â–²":"â–¼"),1)]),c(g,{"enter-active-class":"transition duration-100 ease-out","enter-from-class":"opacity-0 -translate-y-1","leave-active-class":"transition duration-75 ease-in","leave-to-class":"opacity-0 -translate-y-1"},{default:u(()=>[d(B).showFonts.value?(r(),s("div",te,[(r(!0),s(b,null,x(d(q),e=>(r(),s("button",{key:e,class:y(["w-full text-left px-3 py-1.5 text-sm hover:bg-zinc-50 transition-colors",e===d(B).txtFont.value?"text-zinc-900 font-semibold bg-zinc-50":"text-zinc-600"]),style:f({fontFamily:e}),onClick:v(t=>d(B).setFont(e),["stop"])},p(e),15,oe))),128))])):w("",!0)]),_:1})]),t[29]||(t[29]=h("div",{class:"w-px h-5 bg-zinc-200 mx-0.5 shrink-0"},null,-1)),h("div",ne,[h("button",{class:y(Je()),onClick:t[1]||(t[1]=e=>d(B).changeSize(-1))},"âˆ’",2),h("span",le,p(d(B).txtSize.value),1),h("button",{class:y(Je()),onClick:t[2]||(t[2]=e=>d(B).changeSize(1))},"+",2)]),t[30]||(t[30]=h("div",{class:"w-px h-5 bg-zinc-200 mx-0.5 shrink-0"},null,-1)),h("button",{class:y([Je(d(B).txtBold.value),"!font-bold !text-sm"]),onClick:t[3]||(t[3]=(...e)=>d(B).toggleBold&&d(B).toggleBold(...e))},"B",2),h("button",{class:y([Je(d(B).txtItalic.value),"!italic !text-sm"]),onClick:t[4]||(t[4]=(...e)=>d(B).toggleItalic&&d(B).toggleItalic(...e))},"I",2),h("button",{class:y([Je(d(B).txtUnder.value),"!underline !text-sm"]),onClick:t[5]||(t[5]=(...e)=>d(B).toggleUnder&&d(B).toggleUnder(...e))},"U",2),t[31]||(t[31]=h("div",{class:"w-px h-5 bg-zinc-200 mx-0.5 shrink-0"},null,-1)),(r(),s(b,null,x({left:[[0,.5,14,1.5],[0,3.5,9,1.5],[0,6.5,14,1.5],[0,9.5,7,1.5]],center:[[0,.5,14,1.5],[2.5,3.5,9,1.5],[0,6.5,14,1.5],[3.5,9.5,7,1.5]],right:[[0,.5,14,1.5],[5,3.5,9,1.5],[0,6.5,14,1.5],[7,9.5,7,1.5]]},(e,t)=>h("button",{key:t,class:y(Je(d(B).txtAlign.value===t)),title:t,onClick:e=>d(B).setAlign(t)},[(r(),s("svg",re,[(r(!0),s(b,null,x(e,([e,t,o,n],l)=>(r(),s("rect",{key:l,x:e,y:t,width:o,height:n,rx:".75",fill:"currentColor"},null,8,se))),128))]))],10,ae)),64)),t[32]||(t[32]=h("div",{class:"w-px h-5 bg-zinc-200 mx-0.5 shrink-0"},null,-1)),h("label",ie,[h("span",{class:"text-sm font-bold select-none leading-none",style:f({color:d(B).txtColor.value})},"A",4),h("input",{type:"color",value:d(B).txtColor.value,class:"absolute inset-0 opacity-0 w-full h-full cursor-pointer",onInput:t[6]||(t[6]=(...e)=>d(B).applyTxtColor&&d(B).applyTxtColor(...e))},null,40,ce)])],36)):w("",!0)]),_:1})])),h("aside",ue,[h("button",{class:y(Ge(d(B).canvasDark.value)),title:"Toggle theme",onClick:t[8]||(t[8]=e=>d(B).canvasDark.value=!d(B).canvasDark.value)},[h("span",de,p(d(B).canvasDark.value?"â˜€ï¸":"ðŸŒ™"),1)],2),h("button",{class:y(Ge(d(B).gridVisible.value)),title:"Toggle grid",onClick:t[9]||(t[9]=e=>d(B).gridVisible.value=!d(B).gridVisible.value)},[...t[33]||(t[33]=[k('<svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect></svg>',1)])],2),t[48]||(t[48]=h("div",{class:"w-8 h-px my-1 bg-zinc-100 shrink-0"},null,-1)),h("button",{class:y(Ge("pen"===d(B).tool.value)),title:"Pen  [D]",onClick:t[10]||(t[10]=e=>d(B).setTool("pen"))},[...t[34]||(t[34]=[k('<svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 19l7-7 3 3-7 7-3-3z"></path><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"></path><path d="M2 2l7.586 7.586"></path><circle cx="11" cy="11" r="2"></circle></svg>',1)])],2),h("button",{class:y(Ge("eraser"===d(B).tool.value)),title:"Eraser  [E]",onClick:t[11]||(t[11]=e=>d(B).setTool("eraser"))},[...t[35]||(t[35]=[h("svg",{class:"w-4 h-4",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[h("path",{d:"M20 20H7L3 16l10-10 7 7-3 4M6.0001 10.0001l8 8"})],-1)])],2),t[49]||(t[49]=h("div",{class:"w-8 h-px my-1.5 bg-zinc-100 shrink-0"},null,-1)),h("div",ve,[h("div",{ref_key:"colorBtnRef",ref:Y,class:"w-7 h-7 rounded-lg border-2 border-zinc-200 cursor-pointer shadow-inner overflow-hidden hover:scale-105 transition-transform",style:f({backgroundColor:d(B).strokeColor.value}),onClick:v(Ze,["stop"])},null,4)]),(r(),i(m,{to:"body"},[c(g,{"enter-active-class":"transition duration-150 ease-out","enter-from-class":"opacity-0 -translate-x-1 scale-95","leave-active-class":"transition duration-100 ease-in","leave-to-class":"opacity-0 -translate-x-1 scale-95"},{default:u(()=>[P.value?(r(),s("div",{key:0,class:"fixed z-[9999] flex flex-col items-center gap-3 px-4 py-4 bg-white border border-zinc-200 rounded-2xl shadow-xl",style:f({top:G.value.top+"px",left:G.value.left+"px"}),onClick:t[13]||(t[13]=v(()=>{},["stop"]))},[t[36]||(t[36]=h("p",{class:"text-[10px] font-semibold text-zinc-400 uppercase tracking-wider self-start"},"Colour [C]",-1)),C(h("input",{type:"color","onUpdate:modelValue":t[12]||(t[12]=e=>d(B).strokeColor.value=e),class:"w-32 h-32 rounded-xl cursor-pointer border-0 p-0",style:{appearance:"none"}},null,512),[[z,d(B).strokeColor.value]]),h("div",fe,[(r(),s(b,null,x(["#3b82f6","#10b981","#f59e0b","#ef4444","#8b5cf6","#ec4899","#06b6d4","#f97316","#84cc16","#6b7280","#1f2937","#ffffff"],e=>h("div",{key:e,class:"w-6 h-6 rounded-lg cursor-pointer border border-zinc-200/50 hover:scale-110 transition-transform shadow-sm",style:f({backgroundColor:e,outline:d(B).strokeColor.value===e?"2px solid #3b82f6":"none",outlineOffset:"2px"}),onClick:t=>d(B).strokeColor.value=e},null,12,he)),64))])],4)):w("",!0)]),_:1})])),h("button",{ref_key:"brushBtnRef",ref:$,class:y(Ge(E.value)),title:"Brush size  [S]",onClick:v(He,["stop"])},[h("div",{class:"rounded-full bg-current transition-all duration-75",style:f({width:Fe.value,height:Fe.value})},null,4)],2),(r(),i(m,{to:"body"},[c(g,{"enter-active-class":"transition duration-150 ease-out","enter-from-class":"opacity-0 -translate-x-1 scale-95","leave-active-class":"transition duration-100 ease-in","leave-to-class":"opacity-0 -translate-x-1 scale-95"},{default:u(()=>[E.value?(r(),s("div",{key:0,class:"fixed z-[9999] flex flex-col items-center gap-2 px-3 py-3 bg-white border border-zinc-200 rounded-2xl shadow-xl",style:f({top:Z.value.top+"px",left:Z.value.left+"px"}),onClick:t[15]||(t[15]=v(()=>{},["stop"]))},[t[37]||(t[37]=h("p",{class:"text-[10px] font-semibold text-zinc-400 uppercase tracking-wider"},"Size [S]",-1)),h("div",pe,[h("div",{class:"rounded-full transition-all",style:f({width:Math.min(22,Math.max(3,.55*d(B).lineWidth.value))+"px",height:Math.min(22,Math.max(3,.55*d(B).lineWidth.value))+"px",backgroundColor:"eraser"===d(B).tool.value?"#d4d4d8":d(B).strokeColor.value})},null,4)]),C(h("input",{type:"range","onUpdate:modelValue":t[14]||(t[14]=e=>d(B).lineWidth.value=e),min:"1",max:"50",class:"cursor-pointer accent-blue-500",style:{"writing-mode":"vertical-lr",direction:"rtl",width:"4px",height:"100px"}},null,512),[[z,d(B).lineWidth.value,void 0,{number:!0}]]),h("span",ge,p(d(B).lineWidth.value),1)],4)):w("",!0)]),_:1})])),t[50]||(t[50]=h("div",{class:"w-8 h-px my-1.5 bg-zinc-100 shrink-0"},null,-1)),h("button",{class:y(Ge("select"===d(B).tool.value)),title:"Select  [V]",onClick:t[16]||(t[16]=e=>d(B).setTool("select"))},[...t[38]||(t[38]=[h("svg",{class:"w-4 h-4",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[h("path",{d:"M4 4l7.07 17 2.51-7.39L21 11.07z"})],-1)])],2),h("button",{class:y(Ge("connector"===d(B).tool.value)),title:"Connect shapes",onClick:t[17]||(t[17]=e=>d(B).setTool("connector"))},[...t[39]||(t[39]=[h("svg",{class:"w-4 h-4",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[h("path",{d:"M5 12h14"}),h("path",{d:"m15 16 4-4-4-4"}),h("circle",{cx:"5",cy:"12",r:"2",fill:"currentColor",stroke:"none",class:"opacity-60"})],-1)])],2),t[51]||(t[51]=h("div",{class:"w-8 h-px my-1.5 bg-zinc-100 shrink-0"},null,-1)),h("div",be,[h("button",{class:y(Ge()),title:`Add ${Te.value.label}`,onClick:t[18]||(t[18]=e=>d(B).addShape(d(B).activeShape.value))},[h("span",ye,p(Te.value.icon),1)],10,xe),h("button",{ref_key:"shapeBtnRef",ref:V,class:"text-[9px] px-1 py-0.5 rounded leading-none text-zinc-400 hover:text-zinc-600 transition-colors cursor-pointer",title:"More shapes",onClick:v(Ye,["stop"])},p(R.value?"â–²":"â–¼"),513)]),(r(),i(m,{to:"body"},[c(g,{"enter-active-class":"transition duration-150 ease-out","enter-from-class":"opacity-0 -translate-x-1 scale-95","leave-active-class":"transition duration-100 ease-in","leave-to-class":"opacity-0 -translate-x-1 scale-95"},{default:u(()=>[R.value?(r(),s("div",{key:0,class:"fixed z-[9999] bg-white border border-zinc-200 rounded-2xl shadow-xl p-2 flex flex-col gap-1",style:f({top:H.value.top+"px",left:H.value.left+"px"}),onClick:t[19]||(t[19]=v(()=>{},["stop"]))},[(r(!0),s(b,null,x(d(X),e=>(r(),s("div",{key:e.key,class:y(["flex items-center gap-2 px-3 py-1.5 rounded-lg cursor-pointer hover:bg-zinc-50 transition-colors",d(B).activeShape.value===e.key?"bg-blue-50 text-blue-600":"text-zinc-700"]),onClick:t=>{return o=e.key,B.activeShape.value=o,R.value=!1,void B.addShape(o);var o}},[h("span",me,p(e.icon),1),h("span",ke,p(e.label),1)],10,we))),128))],4)):w("",!0)]),_:1})])),h("button",{class:y(Ge("text"===d(B).tool.value)),title:"Add text box  [T]",onClick:t[20]||(t[20]=e=>d(B).addText())},[...t[40]||(t[40]=[h("span",{class:"text-[15px] font-bold leading-none",style:{"font-family":"serif"}},"T",-1)])],2),t[52]||(t[52]=h("div",{class:"w-8 h-px my-1.5 bg-zinc-100 shrink-0"},null,-1)),h("button",{class:y(Ge()),title:"Group / Ungroup  [Ctrl+G]",onClick:t[21]||(t[21]=e=>d(B).groupOrUngroup())},[...t[41]||(t[41]=[k('<svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="8" height="8" rx="1"></rect><rect x="14" y="2" width="8" height="8" rx="1"></rect><rect x="2" y="14" width="8" height="8" rx="1"></rect><rect x="14" y="14" width="8" height="8" rx="1"></rect></svg>',1)])],2),t[53]||(t[53]=h("div",{class:"w-8 h-px my-1.5 bg-zinc-100 shrink-0"},null,-1)),h("button",{class:y(Ge()),title:"Undo  [Ctrl+Z]",onClick:t[22]||(t[22]=e=>d(B).undo())},[...t[42]||(t[42]=[h("svg",{class:"w-4 h-4",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[h("path",{d:"M3 7v6h6"}),h("path",{d:"M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"})],-1)])],2),h("button",{class:y(Ge()),title:"Redo  [Ctrl+Shift+Z]",onClick:t[23]||(t[23]=e=>d(B).redo())},[...t[43]||(t[43]=[h("svg",{class:"w-4 h-4",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[h("path",{d:"M21 7v6h-6"}),h("path",{d:"M3 17a9 9 0 0 1 9-9 9 9 0 0 1 6 2.3L21 13"})],-1)])],2),h("button",{class:y(Ge(!1,!0)),title:"Clear canvas",onClick:t[24]||(t[24]=e=>d(B).clear())},[...t[44]||(t[44]=[h("svg",{class:"w-4 h-4",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[h("polyline",{points:"3 6 5 6 21 6"}),h("path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"})],-1)])],2),t[54]||(t[54]=h("div",{class:"w-8 h-px my-1.5 bg-zinc-100 shrink-0"},null,-1)),h("button",{class:y(Ge()),title:d(S).saving?"Savingâ€¦":"Save  [Ctrl+S]",disabled:d(S).saving,onClick:$e},[d(S).saving?(r(),s("svg",Ae,[...t[46]||(t[46]=[h("circle",{cx:"12",cy:"12",r:"10","stroke-dasharray":"31.4","stroke-dashoffset":"10","stroke-linecap":"round"},null,-1)])])):(r(),s("svg",ze,[...t[45]||(t[45]=[h("path",{d:"M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"},null,-1),h("polyline",{points:"17 21 17 13 7 13 7 21"},null,-1),h("polyline",{points:"7 3 7 8 15 8"},null,-1)])]))],10,Ce),h("button",{class:y(Ge()),title:"Export PNG  [Ctrl+P]",onClick:t[25]||(t[25]=e=>d(B).exportPNG())},[...t[47]||(t[47]=[h("svg",{class:"w-4 h-4",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[h("path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"}),h("polyline",{points:"7 10 12 15 17 10"}),h("line",{x1:"12",y1:"15",x2:"12",y2:"3"})],-1)])],2)]),h("div",{ref_key:"containerRef",ref:F,class:"flex-1 min-w-0 h-full relative overflow-hidden"},[h("div",{class:"absolute inset-0 transition-colors duration-300",style:f({backgroundColor:d(B).bgColor.value})},null,4),h("canvas",{ref_key:"gridCanvasRef",ref:D,class:"absolute inset-0 z-[1] pointer-events-none",style:{display:"block",width:"100%",height:"100%"}},null,512),d(S).loading?(r(),s("div",_e,[...t[55]||(t[55]=[h("svg",{class:"w-8 h-8 animate-spin text-blue-400",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[h("circle",{cx:"12",cy:"12",r:"10","stroke-dasharray":"31.4","stroke-dashoffset":"10","stroke-linecap":"round"})],-1)])])):w("",!0),Ee.value?(r(),s("div",je,p(Ee.value),1)):w("",!0),h("div",Se,[d(B).isPanning.value?(r(),s(b,{key:0},[A("Panning â€” release Ctrl to stop")],64)):"connector"===d(B).tool.value?(r(),s(b,{key:1},[A("Click shape anchor â†’ drag â†’ release on another shape")],64)):"text"===d(B).tool.value?(r(),s(b,{key:2},[A("Click canvas to place text")],64)):(r(),s(b,{key:3},[A("Ctrl+drag to pan Â· Shift+click multi-select Â· Ctrl+A select all Â· Del to remove")],64))]),h("div",Oe,[h("button",{class:y("flex items-center justify-center w-8 h-8 rounded-lg bg-white/80 backdrop-blur-sm border border-zinc-200 text-zinc-500 hover:bg-white hover:text-zinc-700 shadow-sm transition-all duration-100 cursor-pointer select-none"),title:"Zoom in",onClick:t[26]||(t[26]=e=>d(B).zoomIn())},[...t[56]||(t[56]=[h("span",{class:"text-sm font-bold leading-none"},"+",-1)])],2),h("button",{class:y("flex items-center justify-center w-8 h-8 rounded-lg bg-white/80 backdrop-blur-sm border border-zinc-200 text-zinc-500 hover:bg-white hover:text-zinc-700 shadow-sm transition-all duration-100 cursor-pointer select-none"),title:"Zoom out",onClick:t[27]||(t[27]=e=>d(B).zoomOut())},[...t[57]||(t[57]=[h("span",{class:"text-sm font-bold leading-none"},"âˆ’",-1)])],2),h("button",{class:y("flex items-center justify-center w-8 h-8 rounded-lg bg-white/80 backdrop-blur-sm border border-zinc-200 text-zinc-500 hover:bg-white hover:text-zinc-700 shadow-sm transition-all duration-100 cursor-pointer select-none"),title:"Reset zoom",onClick:t[28]||(t[28]=e=>d(B).zoomReset())},[...t[58]||(t[58]=[h("span",{class:"text-[10px] font-mono leading-none"},"1:1",-1)])],2)]),h("canvas",{ref_key:"canvasElRef",ref:T,class:"absolute inset-0 z-[2]",style:f({display:"block",width:"100%",height:"100%",cursor:Pe.value})},null,4)],512)]))}};export{Ie as default};
